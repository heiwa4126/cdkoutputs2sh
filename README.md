# cdkoutputs2sh

[![npm version](https://img.shields.io/npm/v/cdkoutputs2sh.svg)](https://www.npmjs.com/package/cdkoutputs2sh)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?logo=typescript&logoColor=white)](https://www.typescriptlang.org/)
[![Node.js](https://img.shields.io/badge/Node.js-18%2B-green.svg)](https://nodejs.org/)

[日本語](README-ja.md) | English

cdkoutputs2sh is a CLI tool and library that converts AWS CDK stack output JSON files (generated by `cdk deploy --outputs-file var/outputs.json`) into sourceable shell environment variable export scripts (`var/outputs.sh`).

## Features

- Automatic conversion from CDK output (JSON) to `export VAR=...` format
- Preserves mapping between variable names and original `StackName.OutputKey` in comments
- Safe shell quoting with single quotes
- Warns and skips non-scalar values (arrays/objects)
- Detects variable name collisions and exits with error

## Installation

```bash
npm install -D cdkoutputs2sh
```

## Usage

1. Deploy with CDK and generate JSON output
   ```sh
   cdk deploy --outputs-file var/outputs.json
   ```
2. Convert to shell script
   ```sh
   cdkoutputs2sh --input var/outputs.json --output var/outputs.sh
   ```
3. Source the generated script
   ```sh
   source var/outputs.sh
   echo "$AWSCDKP0STACK_INSTANCEID"
   ```

## Options

| Option            | Alias    | Description                      | Default          |
| ----------------- | -------- | -------------------------------- | ---------------- |
| --input <path>    | -i       | Input JSON file                  | var/outputs.json |
| --output <path>   | -o       | Output shell script              | var/outputs.sh   |
| --fail-on-missing | none     | Fail if input file doesn't exist | false            |
| --verbose         | -v / -vv | Log level (INFO / DEBUG)         | none             |
| --help            | -h       | Show help                        | -                |

## Variable Name Generation Rules

1. Combine StackName_OutputKey and convert to uppercase
2. Replace non-alphanumeric characters with _ and merge consecutive _ into one
3. Remove leading/trailing \_
4. Add V\_ prefix if starts with a number
5. Add CDK\_ prefix if stack name starts with Cdk (for sample compatibility)
6. Error on collision

### Examples:

- AwsCdkP0Stack.InstanceId → AWSCDKP0STACK_INSTANCEID
- CdkLambdaUrls1Stack.Lambda1FunctionUrl → CDK_CDKLAMBDAURLS1STACK_LAMBDA1FUNCTIONURL

## Limitations and Notes

- Array/object values are skipped
- Change CDK Output names if collision occurs
- Output file permissions are set to 0644

## Node.js API

```javascript
import { convertCdkOutputs } from "cdkoutputs2sh";

const { exportBlock, mapping } = convertCdkOutputs({
  input: "var/outputs.json",
  output: "var/outputs.sh",
  verbose: 1,
});

console.log(exportBlock);
console.log(mapping["AWSCDKP0STACK_INSTANCEID"]);
```

## Development

After cloning the repository:

```sh
npm run init  # Not `npm init`. See run-scripts
npm run smoketest # Shows help message
npm test # Vitest test cases
```

## License

MIT License
